<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR è¨Šè™Ÿå¼·åº¦æª¢æ¸¬å™¨</title>
    <link rel="stylesheet" href="codepen.css">
</head>
<body>
    <!-- éœæ…‹ fallback æŒ‰éˆ•ï¼šåœ¨æ¥µç«¯æƒ…æ³ä¸‹ç¢ºä¿æ‰‹æ©Ÿèƒ½çœ‹åˆ°å•Ÿå‹•æŒ‰éˆ•ï¼ˆé è¨­éš±è—ï¼Œç”± CSS åœ¨ mobile-await-ar é¡¯ç¤ºï¼‰ -->
    <button id="mobileStartARFallback" style="display:none;">ğŸš€ å•Ÿå‹• AR</button>
    <!-- æ‰‹æ©Ÿç›¸æ©Ÿå½±ç‰‡ï¼ˆlocation-based AR fallbackï¼‰ -->
    <video id="arVideo" autoplay playsinline muted style="display:none;position:fixed;left:0;top:0;width:100%;height:100%;object-fit:cover;z-index:0;">
        æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å½±ç‰‡æ’­æ”¾ã€‚
    </video>
    <!-- A-Frame + AR.js location-based sceneï¼ˆé è¨­éš±è—ï¼Œç”± JS æ§åˆ¶é¡¯ç¤ºï¼‰ -->
    <a-scene id="aframeScene" vr-mode-ui="enabled: false" embedded arjs="sourceType: webcam; debugUIEnabled: false" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:10020;">
        <!-- gps-camera æœƒè‡ªå‹•è«‹æ±‚ geolocation æ¬Šé™ -->
        <a-entity gps-camera rotation-reader></a-entity>
        <a-entity id="aGridRoot"></a-entity>
    </a-scene>
    <div id="loading">
        <div class="spinner"></div>
        <div>æ­£åœ¨åˆå§‹åŒ– AR ç’°å¢ƒ...</div>
        <div id="loadingDetails" style="margin-top: 15px; font-size: 14px; color: rgba(255,255,255,0.7); font-weight: 500;">è¼‰å…¥ Three.js...</div>
    </div>

    <div id="info" class="glass-card">
        <h3>ğŸ›°ï¸ AR è¨Šè™Ÿå¼·åº¦æª¢æ¸¬å™¨</h3>
        <div id="status">æ­£åœ¨å•Ÿå‹•ç³»çµ±...</div>
        <div id="location">ğŸ“ ä½ç½®: åµæ¸¬ä¸­...</div>
        <div id="mode">ğŸ–¥ï¸ æ¨¡å¼: æ¡Œé¢æ¨¡å¼</div>
        <div id="debug" style="margin-top: 12px; font-size: 11px; color: rgba(255,255,255,0.6);"></div>
    </div>

    <div id="legend" class="glass-card">
        <div style="display:flex; align-items:center; justify-content:space-between;">
            <h4 style="margin:0; font-size:16px;">ğŸ“¶ è¨Šè™Ÿå¼·åº¦åœ–ä¾‹</h4>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%);"></div>
            <span>æ¥µå¼·è¨Šè™Ÿ (80-100%)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #ff8000 0%, #ff6600 100%);"></div>
            <span>å¼·è¨Šè™Ÿ (50-80%)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #ffff00 0%, #ffcc00 100%);"></div>
            <span>ä¸­ç­‰è¨Šè™Ÿ (25-50%)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #00ff40 0%, #00cc33 100%);"></div>
            <span>å¼±è¨Šè™Ÿ (8-25%)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #0080ff 0%, #0066cc 100%);"></div>
            <span>æ¥µå¼±è¨Šè™Ÿ (0-8%)</span>
        </div>
    </div>

    <div id="controls" class="glass-card">
        <div class="button-group">
            <button id="toggleAR" style="display:none;">ğŸš€ å•Ÿå‹• AR</button>
            <button id="resetView">ğŸ”„ é‡ç½®è¦–è§’</button>
            <button id="toggleGrid">ğŸ‘ï¸ éš±è—ç¶²æ ¼</button>
        </div>
        <div style="display:flex; gap:8px; margin-top:8px;">
            <button id="collapseInfo" style="flex:1; padding:8px 10px; font-size:13px;">éš±è—è³‡è¨Š</button>
            <button id="collapseLegend" style="flex:1; padding:8px 10px; font-size:13px;">éš±è—åœ–ä¾‹</button>
        </div>
        <div class="control-hint">
            <div class="control-hint-title">ğŸ® æ¡Œé¢æ¨¡æ“¬æ§åˆ¶</div>
            <div class="control-item">
                <span class="control-key">âŒ¨ï¸ WASD</span>
                <span>åœ°é¢ç§»å‹•</span>
            </div>
            <div class="control-item">
                <span class="control-key">ğŸ–±ï¸ æ»‘é¼ </span>
                <span>è½‰å‹•è¦–è§’</span>
            </div>
            <div class="control-item">
                <span class="control-key">âš¡ Shift</span>
                <span>å¿«é€Ÿç§»å‹•</span>
            </div>
            <div style="margin-top: 12px; padding: 10px; background: rgba(255, 255, 255, 0.08); border-radius: 8px; font-size: 12px; color: rgba(255,255,255,0.8);">
                <div>ğŸ’¡ ç¶²æ ¼é¡¯ç¤ºå‘¨åœè¨Šè™Ÿå¼·åº¦</div>
                <div>ğŸ“¡ ç§»å‹•æ™‚å³æ™‚æ›´æ–°æ•¸æ“š</div>
            </div>
        </div>
    </div>

    <script src="//cdn.jsdelivr.net/npm/eruda"></script>
    <script>
        eruda.init();
    </script>

    <!-- Three.js å’Œæ§åˆ¶å™¨ -->
    <script>
        // ç«‹å³å¼·åˆ¶éš±è—å•Ÿå‹•æŒ‰éˆ•ï¼ˆé˜²æ­¢åœ¨æ¨£å¼/race condition ä¸‹ä¸€é–‹å§‹å°±é¡¯ç¤ºï¼‰
        (function(){
            try {
                var b = document.getElementById('toggleAR');
                if (b) b.style.setProperty('display', 'none', 'important');
            } catch(e) { /* ignore */ }
        })();
    </script>
    <!-- A-Frame & AR.js (aframe-ar.js includes a compatible THREE) -->
    <script src="https://unpkg.com/aframe@1.4.2/dist/aframe.min.js"></script>
    <script>
        // ç¢ºä¿åœ¨è¼‰å…¥ aframe-ar.js å‰ï¼Œè‹¥ A-Frame å·²è¨»å†Š THREEï¼Œå°‡å…¶æš´éœ²ç‚ºå…¨åŸŸ THREE
        try {
            if (typeof THREE === 'undefined' && window.AFRAME && AFRAME.THREE) {
                window.THREE = AFRAME.THREE;
                console.log('å·²å°‡ AFRAME.THREE æŒ‡æ´¾åˆ° window.THREE (pre-aframe-ar)');
            }
        } catch (e) { /* ignore */ }
    </script>
    <script>
        // å‹•æ…‹è¼‰å…¥ aframe-ar.jsï¼šç­‰åˆ° A-Frame èˆ‡ AFRAME.THREE/AFRAME.registerComponent æº–å‚™å¥½å¾Œå†æ³¨å…¥ã€‚
        // é€™å¯é¿å… aframe-ar.js åœ¨å…¨åŸŸ THREE å°šæœªå°±ç·’æ™‚åŸ·è¡Œè€Œç”¢ç”Ÿ "Cannot set properties of undefined" ç­‰éŒ¯èª¤ã€‚
        (function(){
            const urls = [
                'https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js',
                'https://unpkg.com/ar.js@3.4.0/aframe/build/aframe-ar.js'
            ];

            function loadScript(url, timeout = 12000) {
                return new Promise((resolve, reject) => {
                    const s = document.createElement('script');
                    let timer = null;
                    s.src = url;
                    s.async = true;
                    s.onload = () => { if (timer) clearTimeout(timer); resolve(url); };
                    s.onerror = (e) => { if (timer) clearTimeout(timer); reject(new Error('è¼‰å…¥å¤±æ•—: ' + url)); };
                    timer = setTimeout(() => { s.onload = null; s.onerror = null; reject(new Error('è¼‰å…¥é€¾æ™‚: ' + url)); }, timeout);
                    document.head.appendChild(s);
                });
            }

            function waitForAFRAME(timeout = 3000) {
                return new Promise((resolve, reject) => {
                    const start = Date.now();
                    (function check(){
                        if (window.AFRAME && (window.AFRAME.THREE || window.THREE) && typeof AFRAME.registerComponent === 'function') return resolve();
                        if (Date.now() - start > timeout) return reject(new Error('AFRAME æœªåœ¨æŒ‡å®šæ™‚é–“å…§å°±ç·’'));
                        setTimeout(check, 50);
                    })();
                });
            }

            // ç­‰å¾… A-Frame å°±ç·’ï¼Œè‹¥å°±ç·’å‰‡ç¢ºä¿ window.THREE æŒ‡å‘ AFRAME.THREEï¼Œç„¶å¾Œè¼‰å…¥ aframe-ar.js
            waitForAFRAME(3000).then(() => {
                try { if (typeof THREE === 'undefined' && window.AFRAME && AFRAME.THREE) window.THREE = AFRAME.THREE; } catch(e) { /* ignore */ }
                (async () => {
                    let loaded = false;
                    for (const url of urls) {
                        try {
                            await loadScript(url);
                            console.log('å·²è¼‰å…¥ aframe-ar.js:', url);
                            loaded = true;
                            break;
                        } catch (err) {
                            console.warn('è¼‰å…¥ aframe-ar.js å¤±æ•—ï¼Œå˜—è©¦ä¸‹ä¸€å€‹ä¾†æº:', url, err);
                        }
                    }
                    if (!loaded) console.error('ç„¡æ³•è¼‰å…¥ aframe-ar.jsï¼ŒAR åŠŸèƒ½å¯èƒ½å—é™');
                })();
            }).catch((err) => {
                // è‹¥ A-Frame æœªåœ¨æ™‚é–“å…§å°±ç·’ï¼Œä»å˜—è©¦è¼‰å…¥ä¸€æ¬¡ï¼ˆæœ‰æ™‚å€™ç¶²è·¯å»¶é²æˆ–è³‡æºé †åºä¸åŒï¼‰
                console.warn('ç­‰å¾… A-Frame å°±ç·’é€¾æ™‚ï¼Œä»å˜—è©¦è¼‰å…¥ aframe-ar.js:', err);
                loadScript(urls[0]).then(() => console.log('å·²è¼‰å…¥ aframe-ar.js (fallback)')).catch(e => console.error('aframe-ar.js fallback è¼‰å…¥å¤±æ•—', e));
            });
        })();
    </script>
    <script>
        // æ›´æ–°è¼‰å…¥ç‹€æ…‹
        function updateLoadingStatus(message) {
            const element = document.getElementById('loadingDetails');
            if (element) element.textContent = message;
        }

        // å†æ¬¡ä¿éšªæ€§ç¢ºä¿ THREE å…¨åŸŸå¯ç”¨ï¼ˆè‹¥ A-Frame å·²è¼‰å…¥å‰‡ä½¿ç”¨ AFRAME.THREEï¼‰
        updateLoadingStatus('A-Frame è¼‰å…¥å®Œæˆï¼Œæ­£åœ¨è¨­å®šæ§åˆ¶å™¨...');
        try {
            if (typeof THREE === 'undefined' && window.AFRAME && AFRAME.THREE) {
                window.THREE = AFRAME.THREE;
            }
        } catch (e) { /* ignore */ }
        console.log('Three.js available:', typeof THREE !== 'undefined');
        
        // ç°¡åŒ–ç‰ˆçš„è»Œé“æ§åˆ¶å™¨
        class SimpleOrbitControls {
            constructor(camera, domElement) {
                this.camera = camera;
                this.domElement = domElement;
                this.enableDamping = true;
                this.dampingFactor = 0.05;
                this.maxPolarAngle = Math.PI / 2;
                
                // æ§åˆ¶ç‹€æ…‹
                this.enabled = true;
                this.target = new THREE.Vector3();
                
                // çƒé¢åº§æ¨™
                this.spherical = new THREE.Spherical();
                this.sphericalDelta = new THREE.Spherical();
                this.scale = 1;
                this.panOffset = new THREE.Vector3();
                
                // æ»‘é¼ ç‹€æ…‹
                this.rotateStart = new THREE.Vector2();
                this.rotateEnd = new THREE.Vector2();
                this.rotateDelta = new THREE.Vector2();
                
                this.isMouseDown = false;
                this.mouseButton = -1;
                
                this.setupEventListeners();
                this.update(); // åˆå§‹æ›´æ–°
            }
            
            setupEventListeners() {
                if (!this.domElement) return;
                
                this.domElement.addEventListener('mousedown', this.onMouseDown.bind(this));
                this.domElement.addEventListener('mousemove', this.onMouseMove.bind(this));
                this.domElement.addEventListener('mouseup', this.onMouseUp.bind(this));
                this.domElement.addEventListener('wheel', this.onWheel.bind(this));
                
                // é˜²æ­¢å³éµèœå–®
                this.domElement.addEventListener('contextmenu', (event) => {
                    event.preventDefault();
                });
            }
            
            onMouseDown(event) {
                if (!this.enabled) return;
                
                this.isMouseDown = true;
                this.mouseButton = event.button;
                
                if (event.button === 0) { // å·¦éµæ—‹è½‰
                    this.rotateStart.set(event.clientX, event.clientY);
                }
                
                event.preventDefault();
            }
            
            onMouseMove(event) {
                if (!this.enabled || !this.isMouseDown) return;
                
                if (this.mouseButton === 0) { // å·¦éµæ—‹è½‰
                    this.rotateEnd.set(event.clientX, event.clientY);
                    this.rotateDelta.subVectors(this.rotateEnd, this.rotateStart);
                    
                    // è¨ˆç®—æ—‹è½‰è§’åº¦
                    const element = this.domElement === document ? this.domElement.body : this.domElement;
                    const rotateLeft = 2 * Math.PI * this.rotateDelta.x / element.clientWidth;
                    const rotateUp = 2 * Math.PI * this.rotateDelta.y / element.clientHeight;
                    
                    this.sphericalDelta.theta -= rotateLeft;
                    this.sphericalDelta.phi -= rotateUp;
                    
                    this.rotateStart.copy(this.rotateEnd);
                }
                
                event.preventDefault();
            }
            
            onMouseUp(event) {
                this.isMouseDown = false;
                this.mouseButton = -1;
            }
            
            onWheel(event) {
                if (!this.enabled) return;
                
                if (event.deltaY < 0) {
                    this.scale /= 1.1;
                } else {
                    this.scale *= 1.1;
                }
                
                // é™åˆ¶ç¸®æ”¾ç¯„åœ
                this.scale = Math.max(0.1, Math.min(10, this.scale));
                
                event.preventDefault();
            }
            
            update() {
                if (!this.enabled) return;
                
                const offset = new THREE.Vector3();
                const position = this.camera.position;
                
                offset.copy(position).sub(this.target);
                this.spherical.setFromVector3(offset);
                
                this.spherical.theta += this.sphericalDelta.theta;
                this.spherical.phi += this.sphericalDelta.phi;
                
                // é™åˆ¶ä»°è§’
                this.spherical.phi = Math.max(0.000001, Math.min(this.maxPolarAngle, this.spherical.phi));
                this.spherical.radius *= this.scale;
                
                // é™åˆ¶è·é›¢
                this.spherical.radius = Math.max(0.1, Math.min(100, this.spherical.radius));
                
                offset.setFromSpherical(this.spherical);
                position.copy(this.target).add(offset);
                
                this.camera.lookAt(this.target);
                
                if (this.enableDamping) {
                    this.sphericalDelta.theta *= (1 - this.dampingFactor);
                    this.sphericalDelta.phi *= (1 - this.dampingFactor);
                    this.scale = 1 + (this.scale - 1) * (1 - this.dampingFactor);
                } else {
                    this.sphericalDelta.set(0, 0, 0);
                    this.scale = 1;
                }
                
                return true;
            }
            
            reset() {
                this.camera.position.set(0, 1.6, 3);
                this.target.set(0, 0, 0);
                this.camera.lookAt(this.target);
                this.sphericalDelta.set(0, 0, 0);
                this.scale = 1;
            }
        }
        
        // å°‡æ§åˆ¶å™¨æ·»åŠ åˆ° THREE å‘½åç©ºé–“
        THREE.OrbitControls = SimpleOrbitControls;
        
        updateLoadingStatus('æ§åˆ¶å™¨è¨­å®šå®Œæˆï¼Œè¼‰å…¥æ‡‰ç”¨ç¨‹å¼...');
        console.log('OrbitControls å·²è¨­å®š');
    </script>

    <script>
        // UI æ”¶åˆæ§åˆ¶ï¼ˆè¼•é‡ï¼‰
        document.addEventListener('DOMContentLoaded', () => {
            // å¦‚æœæ˜¯å°è¢å¹•ï¼ˆæ‰‹æ©Ÿï¼‰ï¼Œé è¨­å…ˆéš±è—å¤§éƒ¨åˆ† UIï¼Œåƒ…é¡¯ç¤ºé–‹å§‹ AR æŒ‰éˆ•ã€‚
            const isMobileViewport = (window.matchMedia && window.matchMedia('(max-width: 480px)').matches) || /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent || '');
            if (isMobileViewport) {
                document.body.classList.add('mobile-await-ar');
                // å¼·åˆ¶é¡¯ç¤ºéœæ…‹ fallback æŒ‰éˆ•ï¼ˆä»¥é˜² CSS è¦å‰‡æˆ–å…¶ä»–è…³æœ¬é®è”½ï¼‰
                try {
                    const staticBtn = document.getElementById('mobileStartARFallback');
                    if (staticBtn) staticBtn.style.display = 'block';
                } catch (e) { /* ignore */ }
            }

            // å¦‚æœæ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å®Œæˆå¾Œæ‰é¡¯ç¤ºå•Ÿå‹•æŒ‰éˆ•ï¼Œç›£è½ arapp:ready
            const showStartButton = () => {
                try {
                    // åªæœ‰åœ¨æ‡‰ç”¨å·²åˆå§‹åŒ–ä¸” AR æ”¯æ´æª¢æŸ¥å®Œæˆï¼ˆé falseï¼‰æ™‚æ‰é¡¯ç¤ºæŒ‰éˆ•
                    if (!window.arApp || !window.arApp.isInitialized) return false;
                    if (typeof window.arApp.isARSupported !== 'undefined' && window.arApp.isARSupported === false) {
                        // æ˜ç¢ºä¸æ”¯æ´ ARï¼šä¸é¡¯ç¤ºä¸»æŒ‰éˆ•ï¼ˆmobile fallback é‚è¼¯å¯é¡¯ç¤ºå…¶ä»–èªªæ˜ï¼‰
                        return false;
                    }

                    const btn = document.getElementById('toggleAR');
                    if (btn) {
                        // ä½¿ç”¨ inline style ä¸¦æŒ‡å®š important ä»¥è¦†è“‹é è¨­ CSS
                        btn.style.setProperty('display', 'inline-block', 'important');
                        btn.disabled = !!(window.arApp && window.arApp.isARSupported === false);
                    }
                    return true;
                } catch (e) { /* ignore */ }
                return false;
            };

            // è‹¥ arApp å·²ç¶“å­˜åœ¨ä¸¦åˆå§‹åŒ–å®Œæˆï¼Œä¹Ÿç«‹åˆ»é¡¯ç¤º
            try {
                if (window.arApp && window.arApp.isInitialized && (typeof window.arApp.isARSupported === 'undefined' || window.arApp.isARSupported !== false)) {
                    showStartButton();
                }
            } catch (e) { /* ignore */ }

            // ç•¶æ”¶åˆ° arapp:ready æ™‚ï¼Œé‡è©¦é¡¯ç¤ºï¼ˆè™•ç†å¯èƒ½çš„ race conditionï¼‰
            window.addEventListener('arapp:ready', () => {
                // å˜—è©¦ç«‹å³é¡¯ç¤ºï¼Œè‹¥å¤±æ•—å‰‡åœ¨çŸ­æ™‚é–“å…§é‡è©¦å¹¾æ¬¡
                let attempts = 0;
                const tryShow = () => {
                    attempts++;
                    const ok = showStartButton();
                    if (!ok && attempts < 6) {
                        setTimeout(tryShow, 300);
                    }
                };
                tryShow();
            });

            const legend = document.getElementById('legend');
            const collapseInfo = document.getElementById('collapseInfo');
            const collapseLegend = document.getElementById('collapseLegend');
            const info = document.getElementById('info');
            const toggleAR = document.getElementById('toggleAR');

            if (collapseInfo && info) {
                collapseInfo.addEventListener('click', () => {
                    info.style.display = (info.style.display === 'none') ? '' : 'none';
                });
            }

            if (collapseLegend && legend) {
                collapseLegend.addEventListener('click', () => {
                    legend.style.display = (legend.style.display === 'none') ? '' : 'none';
                });
            }

            // çµ±ä¸€çš„å•Ÿå‹• AR è¡Œç‚ºï¼šå…ˆç§»é™¤ mobile-await-arï¼Œé¡¯ç¤º UIï¼Œç„¶å¾ŒåŸ·è¡Œ arApp çš„å•Ÿå‹•æˆ–æ¨¡æ“¬æŒ‰éˆ•é»æ“Š
            async function startARFromUI() {
                try {
                    if (document.body.classList.contains('mobile-await-ar')) document.body.classList.remove('mobile-await-ar');
                } catch (e) { /* ignore */ }

                // è‹¥åŸå§‹æŒ‰éˆ•å­˜åœ¨ä¸¦ä¸”æœ‰ click handlerï¼Œå„ªå…ˆè§¸ç™¼å®ƒï¼ˆå¯èƒ½åŒ…å«æ›´å®Œæ•´çš„æµç¨‹ï¼‰
                try {
                    if (toggleAR && typeof toggleAR.click === 'function') {
                        toggleAR.click();
                        return;
                    }
                } catch (e) { /* ignore */ }

                // å¾Œå‚™ï¼šç›´æ¥å‘¼å« arApp çš„ API
                try {
                    if (window.arApp && typeof window.arApp.startAR === 'function') {
                        await window.arApp.startAR();
                        return;
                    } else if (window.arApp && typeof window.arApp.toggleAR === 'function') {
                        window.arApp.toggleAR();
                        return;
                    }
                } catch (err) {
                    console.warn('AR start failed (from startARFromUI):', err);
                }
            }

            // é»æ“Šé–‹å§‹ AR æ™‚ï¼šç¶å®šçµ±ä¸€è™•ç†
            if (toggleAR) {
                toggleAR.addEventListener('click', async (e) => {
                    if (e && typeof e.preventDefault === 'function') e.preventDefault();
                    if (e && typeof e.stopPropagation === 'function') e.stopPropagation();
                    await startARFromUI();
                });
            }

            // æª¢æŸ¥åŸå§‹æŒ‰éˆ•æ˜¯å¦å¯è¦‹ï¼Œå¦‚æœä¸å¯è¦‹æˆ–è¢«è¦†è“‹ï¼Œå»ºç«‹ä¸€å€‹ fallback çš„å¤§æŒ‰éˆ•ï¼Œç¢ºä¿ä½¿ç”¨è€…ä¸€å®šèƒ½æŒ‰åˆ°
            (function ensureMobileFallback() {
                if (!isMobileViewport) return;

                const isVisible = (el) => {
                    if (!el) return false;
                    const style = window.getComputedStyle(el);
                    if (style.display === 'none' || style.visibility === 'hidden' || style.opacity === '0') return false;
                    const rect = el.getBoundingClientRect();
                    if (rect.width === 0 || rect.height === 0) return false;
                    return true;
                };

                // å¦‚æœåŸæœ¬çš„ toggleAR ä¸å¯è¦‹ï¼Œæˆ–ä¸å­˜åœ¨ï¼Œå‰‡å»ºç«‹ fallback æŒ‰éˆ•
                if (!isVisible(toggleAR)) {
                    try {
                        // å¦‚æœå·²ç¶“å»ºç«‹é fallbackï¼Œè·³é
                        if (document.getElementById('mobileStartARFallback')) return;

                        const btn = document.createElement('button');
                        btn.id = 'mobileStartARFallback';
                        btn.textContent = 'ğŸš€ å•Ÿå‹• AR';
                        // å…§è¯æ¨£å¼ä¿è­‰å„ªå…ˆæ¬Šï¼ˆfixed, high z-indexï¼‰
                        Object.assign(btn.style, {
                            position: 'fixed',
                            bottom: '18px',
                            left: '50%',
                            transform: 'translateX(-50%)',
                            zIndex: '10020',
                            padding: '14px 22px',
                            fontSize: '16px',
                            borderRadius: '16px',
                            background: 'linear-gradient(135deg, rgba(255,255,255,0.18) 0%, rgba(255,255,255,0.08) 100%)',
                            color: '#fff',
                            border: '1px solid rgba(255,255,255,0.18)',
                            boxShadow: '0 12px 30px rgba(0,0,0,0.45)'
                        });

                        btn.addEventListener('click', async (ev) => {
                            if (ev && ev.preventDefault) ev.preventDefault();
                            if (ev && ev.stopPropagation) ev.stopPropagation();
                            try { if (document.body.classList.contains('mobile-await-ar')) document.body.classList.remove('mobile-await-ar'); } catch(e) {}
                            try { btn.parentElement && btn.parentElement.removeChild(btn); } catch(e) {}
                            await startARFromUI();
                        });

                        document.body.appendChild(btn);
                    } catch (e) {
                        console.warn('å»ºç«‹ mobile fallback button å¤±æ•—', e);
                    }
                }
            })();
            // ç‚ºéœæ…‹ fallback æŒ‰éˆ•ä¹Ÿç¶å®šè¡Œç‚ºï¼ˆè‹¥å­˜åœ¨ï¼‰
            try {
                const staticBtn = document.getElementById('mobileStartARFallback');
                if (staticBtn && !staticBtn.dataset.bound) {
                    staticBtn.addEventListener('click', async (e) => {
                        if (e && e.preventDefault) e.preventDefault();
                        if (e && e.stopPropagation) e.stopPropagation();
                        try { if (document.body.classList.contains('mobile-await-ar')) document.body.classList.remove('mobile-await-ar'); } catch(e) {}
                        try { staticBtn.style.display = 'none'; } catch(e) {}
                        await startARFromUI();
                    });
                    staticBtn.dataset.bound = '1';
                }
            } catch (e) { /* ignore */ }

            // ä¿è­·ç¶²æ ¼é¡¯ç¤ºï¼šè‹¥ global three app å­˜åœ¨ï¼Œå‘¨æœŸæ€§ç¢ºä¿ gridMesh å¯è¦‹ä¸”ä¸è¢« frustum å‰”é™¤
            setInterval(() => {
                try {
                    if (window.arApp && window.arApp.gridMesh) {
                        window.arApp.gridMesh.frustumCulled = false;
                        window.arApp.gridMesh.visible = window.arApp.gridVisible;
                    }
                } catch (e) { /* ignore */ }
            }, 500);
        });
    </script>
    


</body>
</html>
